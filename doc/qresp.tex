%\documentclass[reprint,prd, superscriptaddress, tightenlines, longbibliography, nofootinbib, eqsecnum, amsfonts, amsmath, floatfix, notitlepage, onecolumn]{revtex4-1}
\documentclass{article}
\usepackage{pgfplots}

\usepackage[a4paper, total={7.1in, 9in}]{geometry}
\usepackage{amsmath} 
\usepackage{amssymb}
\usepackage[utf8]{inputenc}
\usepackage{color}
\newcommand{\T}[0]{{\mathcal T}}
\newcommand{\Xd}[0]{{X^{\rm dat}}}
\newcommand{\Xwf}[0]{{X^{\rm WF}}}
\newcommand{\Cov}[0]{{\textrm{Cov}}}

\newcommand{\si}[0]{{s_{\rm i}}}
\newcommand{\ti}[0]{{t_{\rm i}}}
\newcommand{\ui}[0]{{u_{\rm i}}}
\newcommand{\vi}[0]{{v_{\rm i}}}
\newcommand{\so}[0]{{s_{\rm o}}}
\renewcommand{\to}[0]{{t_{\rm o}}}
\newcommand{\uo}[0]{{u_{\rm o}}}
\newcommand{\vo}[0]{{v_{\rm o}}}

\newcommand{\sr}[0]{{s_{\rm r}}}
\newcommand{\tr}[0]{{t_{\rm r}}}
\newcommand{\ur}[0]{{u_{\rm r}}}
\newcommand{\vr}[0]{{v_{\rm r}}}

\newcommand{\Ylm}[1]{\:_{#1}Y_{\ell m}}
\newcommand{\Ylms}[1]{\:_{#1}Y^*_{\ell m}}
\newcommand{\YLM}[1]{\:_{#1}Y_{L M}}
\newcommand{\YLMs}[1]{\:_{#1}Y^*_{L M}}
\newcommand{\av}[1]{\left\langle #1 \right\rangle}
\newcommand{\resp}{ {\mathcal R} }

\newcommand{\red}[1]{\color{red}#1 \color{black} }
\newcommand{\JC}[1]{\color{red}JC: #1\color{black}}
\newcommand{\hn}[0]{\hat n}
\begin{document}
\title{Notes on curved-sky quadratic estimation}
\maketitle
\tableofcontents
\vspace{1cm}
\JC{Document to be included with the pipeline release after submission of the revised L08.}

\section{Notes on curved-sky quadratic estimation}
Lensing and others quadratic estimators used in Ref.~\cite{Aghanim:2018oex} are all built multiplying in position space spin transforms of spin-weighted fields. The purpose of this document is to collect the relevant formulae in the spin-weight formalism. The numerical implementation of the estimator responses and noise covariances in the released lensing estimation pipeline follows this document.
\newline
\newline
\noindent The gradient (g) and curl (c) modes of definite parity of a spin-$r$ field $_{r}\alpha(\hn)$ with $_{-r}\alpha(\hn) = \:_{r}\alpha^*(\hn)$ are defined through
\begin{eqnarray*}
		g^{r}_{LM} &= -\frac 12\left(\:_{|r|} \alpha_{LM} + (-1)^r \:_{-|r|} \alpha_{LM}\right)\\
		c^{r}_{LM} &=-\frac 1{2i} \left( \:_{|r|} \alpha_{LM} - (-1)^r \:_{-|r|} \alpha_{LM} \right) .
\end{eqnarray*}
where  $_{\pm r} \alpha_{LM} \equiv \int d^2n \:_{\pm r}\alpha(\hn) \:_{\pm r}Y^*_{LM}(\hn)$.
Prior to projection onto gradient and curl modes, and prior to proper normalization, the quadratic estimators can all be written in the form \begin{equation}\label{QE}
 _{r}\hat \alpha(\hn) \equiv  \left(\sum_{\ell m}\: w^{\so\si}_\ell \:_{\si} \bar X_{\ell m} \:_\so Y_{\ell m}(\hn)\right)\left(\sum_{\ell m}\:w^{\to\ti}_\ell  \:_{\ti} \bar X_{\ell m} \:_\to Y_{\ell m}(\hn)\right)
\end{equation}
where $\si, \ti$ are input spins, $\so, \to$ outputs spins with $\to + \so = r$, and $w_\ell^{\so\si}, w_\ell^{\ti\to}$ associated weights. By consistency, the weights have symmetry $w_\ell^{-\so-\si} = (-1)^{\so + \si}w_\ell^{*\so \si}$.
\newline
\newline
The maps $_s \bar X_{lm}$ are the inverse variance filtered CMB maps,
\begin{equation}
	_0 \bar X_{\ell m} = \bar T_{\ell m} , \quad _{\pm 2} \bar X_{\ell m} = -\left(\bar E_{\ell m} \pm i\bar B_{\ell m} \right),
\end{equation}
and (for the purposes of the analytical calculations in this document) are isotropically related to the data maps $_sX$ through a matrix $F$,
\begin{equation}\label{eq:filter}
	_{s}\bar X_{\ell m} \equiv \sum_{s_2 = 0,2,-2}F_\ell^{s s_2} \:_{s_2}X_{\ell m} \quad \textrm{(isotropic approximation of } \bar X = \mathcal B^\dagger \Cov^{-1} X ^\textrm{\rm dat}\textrm{ in the notation of Ref.~\cite{Aghanim:2018oex}}.
\end{equation} 
For independently filtered temperature and polarization such as the Planck 2018 baseline analysis, the filtered $\bar T, \bar E, \bar B$ are directly proportional to $T, E$ and $B$ respectively, with spin-space matrix $F$ in Eq.~\eqref{eq:filter}
\begin{equation}
	F = \begin{pmatrix}
		F^T_\ell & 0 & 0 \\ 0 & \frac 12 \left( F^{E}_\ell  + F^{B}_\ell\right) & \frac 12 \left( F^{E}_\ell  - F^{B}_\ell\right) \\ 0& \frac 12 \left( F^{E}_\ell  - F^{B}_\ell\right) & \frac 12 \left( F^{E}_\ell  + F^{B}_\ell\right)
	\end{pmatrix}
\end{equation}
where
\begin{equation}
F_\ell^{X} = \frac{1}{C_\ell^{XX,\rm fid} + N_\ell^{\rm X} /b_\ell^2}, \quad X = T,E,B.
\end{equation}
In Ref~\cite{Aghanim:2018oex}, $F_\ell^{X}$ is set to zero outside $100 \le \ell \le 2048$, $N^T_\ell$ is $35 \mu$K-amin, $N^P_\ell$ is $55 \mu$K-amin, $b_\ell$ is Gaussian beam of FWHM $5$-amin, and $F_\ell^X$ contains further an additional small rescaling. 
For joint temperature and polarization filtering, the $F$ matrix becomes:
\begin{equation}
	F = \begin{pmatrix}
		F^{TT}_\ell &  -\frac 12 F^{TE} &   -\frac12 F^{TE} \\  -F^{TE} & \frac 12 \left( F^{EE}_\ell  + F^{B}_\ell\right) & \frac 12 \left( F^{EE}_\ell  - F^{B}_\ell\right) \\ -F^{TE}& \frac 12 \left( F^{EE}_\ell  - F^{B}_\ell\right) & \frac 12 \left( F^{EE}_\ell  + F^{B}_\ell\right)
	\end{pmatrix}
\end{equation}
where the entries $F^{T, E, B}$ are the elements of
\begin{equation}
 \begin{pmatrix}  C_\ell^{TT} + N_\ell^T &C^{TE}_\ell &  0 \\ C^{TE}_\ell & C_\ell^{EE} + N_\ell^E  & 0\\  0 & 0 &  C_\ell^{BB} + N_\ell^B
 	
 \end{pmatrix}^{-1}
\end{equation}
\newline
\newline
The formulae exposed in this document can be derived through simple application of this formal relation,
\begin{equation}
\begin{split}
&\sum_{m_1,m_2}\int d^2n\:_{s_1} Y_{\ell_1 m_1}(\hn)\:_{s_2} Y_{\ell_2 m_2}(\hn)\:_{r_1} Y_{L M}(\hn)\int d^2n'\:_{t_1} Y_{\ell_1 m_1}(\hn')\:_{t_2} Y_{\ell_2 m_2}(\hn')\:_{r_2} Y_{L' M'}(\hn')  \\&= \delta_{LL'}\delta_{MM'}\frac{2\ell_1 + 1}{4\pi}\frac{2\ell_2 + 1} {4\pi} 2\pi \int_{-1}^{1} d\mu \: d^{\ell_1}_{s_1,t_1}(\mu)d^{\ell_2}_{s_2 t_2}(\mu)d^{L}_{r_1 r_2}(\mu) \quad (s_1 + s_2 + r_1  = 0 = t_1 + t_2 + r_2).
\end{split}
\end{equation}
where $d^\ell_{mm'}$ are Wigner small d-matrices.
\subsection{Gaussian noise covariance}
Q.E. noise covariance can be evaluated with a series of one-dimensional integrals as was first demonstrated by Ref.~\cite{}. For two generic estimators as defined in Eq.~\eqref{QE}, we now obtain their gradient (g) and curl (c) covariances with four integrals as follows.

For an isotropy estimator $_{r}\hat \alpha$ let $s = (\si, \so, w^{\si\so})$ collectively describes the in and out spins and weight function of the left leg, and similarly with $t$ for the right leg (with $\so + \to = r$). In the same way, let $u$ and $v$ describes another esimator $_{r'}\hat \alpha$ (with $\uo + \vo = r'$). Then, their Gaussian covariance may be written $ \left.\av{\:_{r}\hat \alpha_{LM}\: _{r'}\hat \alpha^*_{L'M'}} \right|_{\rm Gauss} \equiv \delta_{LL'}\delta_{MM'}n_L^{stuv}$ with
\begin{equation}
\boxed{
\begin{split} 
n_L^{stuv} & = (-1)^{r + r'}2\pi  \int_{-1}^1 d \mu\:  d^L_{-r -r'}(\mu) \left[\xi^{su}(\mu)\:\xi^{tv}(\mu)  + \xi^{sv}(\mu)\:\xi^{tu}(\mu) \right]
\end{split}}
\end{equation}
where $\xi$ are position-space correlation functions
\begin{equation}\boxed{
\xi^{st}(\mu) \equiv  \sum_\ell \left(\frac{2\ell + 1}{4\pi}\right)w^{\so\si}_\ell w^{*\to\ti}_\ell \bar C_\ell^{\si \ti} d^\ell_{\so,\to}(\mu)\textrm{ with } \bar C_\ell^{\si \ti} \equiv \av{ _{\si}\bar X_{\ell m}\: _{\ti} \bar X^*_{\ell m} }}.
\end{equation}
Projecting onto gradient and curl modes results in
\begin{equation} \boxed{
\begin{split}
\left.\av{\hat g^{r}_{LM} \hat g^{*, r'}_{L' M'} }\right|_{\rm Gauss.} &=\delta_{LL'}\delta_{MM'} \frac 12 \Re\left[n_L^{stuv} +  (-1)^{r} n^{-s-tuv}_L\right] \\
		\left.\av{\hat c^{r}_{LM} \hat c^{*, r'}_{L' M'} }\right|_{\rm Gauss.} &= \delta_{LL'}\delta_{MM'}\frac 12 \Re\left[n_L^{stuv} -  (-1)^{r} n^{-s-tuv}_L\right]\\
	\left.\av{\hat g^{r}_{LM} \hat c^{*, r'}_{L' M'} }\right|_{\rm Gauss.} &= \delta_{LL'}\delta_{MM'}\frac 12 \Im\left[-n_L^{stuv} -  (-1)^{r} n^{-s-tuv}_L\right] \\ \left.\av{\hat c^{r}_{LM} \hat g^{*, r'}_{L' M'} }\right|_{\rm Gauss.} &= \delta_{LL'}\delta_{MM'}\frac 12 \Im\left[n_L^{stuv} -  (-1)^{r} n^{-s-tuv}_L\right]
\end{split}}
\end{equation}
($\Re$ and $\Im$ stands for real and imaginary parts respectively). 
Ref.~\cite{Aghanim:2018oex} calculates the covariance matrix based on these equations using the empirical, realisation dependent power spectra $\bar C_\ell^{s_i,t_i}$. A gradient-curl mode cross-covariance  may be sourced by gradient-curl couplings in the inverse-variance filtered CMB fields (i.e., non-zero $C_\ell^{\bar T \bar B}$ or $C_\ell^{\bar E \bar B}$). In most relevant situations there is no such couplings and the gradient to curl and curl to gradient covariance vanish.
\subsection{Responses}
We now turn to the calculation of the response of the estimator to a source of anisotropy. Anisotropy can sometimes be parametrized at the level of the CMB maps, (for example for lensing), with
\begin{equation}\label{eq:mapresp}
	_{s}\delta X(\hn) = \sum_{a = \pm r}\:_{a}\alpha(\hn) \left( \sum_{\ell m}\: R_\ell^{a, s} \:_sX_{\ell m} \Ylm {s- a}(\hn)\right)
\end{equation}
for response kernel functions $R^{r,s}_\ell$. More generally, let the covariance of the CMB data respond as follows to a spin-$r$ anisotropy source $\alpha$:
\begin{equation}\label{eq:covresp}
	\delta  \av{_sX(\hn) \:_tX^*(\hn')} =   \sum_{\ell m, a = \pm r}\:_{a}\alpha(\hn) W_\ell^{a, st} \:_{s - a}Y_{\ell m}(\hn)  \:_{t}Y^*_{\ell m}(\hn')  +   W_\ell^{* a, ts} \:_{s}Y_{\ell m}(\hn)  \:_{t-a}Y^*_{\ell m}(\hn')\:_{-a}\alpha(\hn')
\end{equation}
for some weights functions $W_\ell^{a, st}$. For map-level descriptions in Eq.~\eqref{eq:mapresp} then holds
\begin{equation}
	W_\ell^{a, st} = R^{a, s} C_\ell^{st}.
\end{equation}
However, Eq.~\eqref{eq:covresp} is more general.
Examples include:
\begin{enumerate}
	\item Lensing: The source of anisotropy is the spin-1 field $_1\alpha(\hn)$, with linear response (see Ref.~\cite{Challinor:2002cd})
	\begin{equation}
		\delta _sX(\hn) =  -\frac 12 \alpha_1(\hn) \bar \eth _{s}X(\hn) - \frac 12 \alpha_{-1}(\hn) \eth \:_sX(\hn) 
	\end{equation}
	where $\eth$ and $\bar \eth$ are the spin raising and spin lowering operator respectively. Hence
	\begin{equation}
		R_\ell^{-1, s} =- \frac 12\sqrt{ (l - s) (l + s + 1) } \textrm{  and   }R_\ell^{1, s} = +\frac12\sqrt{ (l + s) (l - s + 1) }
	\end{equation}
	\item CMB modulation: The source is spin 0, with response
	\begin{equation}
	\delta _sX(\hn) = \:_0\alpha(\hn) _{s}X(\hn)	
	\textrm{   hence   } R_\ell^{0,s} = 1
	\end{equation}
	\item Point sources in temperature ($S^2$, from Ref.~\cite{Osborne:2013nna}): here anisotropy is sought of the form
	\begin{equation}
	\delta  \av{T(\hn) \:T(\hn')} = \delta_{\hat n\hat n'}S^2(\hn)\textrm{    hence     }
	W^{r, st}_\ell = \frac 14\delta_{r0}\delta_{s0}\delta_{t0} 
	\end{equation}
	\item Polarization rotation (for example from polarization angle miscalibration). There the observed polarization is rotated according to $_{\pm 2} X$ is $e^{\mp 2i \:_{0}\alpha} \: _{\pm 2}X$.
	\begin{equation}
		_{\pm 2}\delta X (\hn)= \mp 2i \:_{0}\alpha(\hn) \:_{\pm 2}X(\hn), \textrm{ hence } R_\ell^{0, \pm 2} = \mp 2i
	\end{equation}
	\item Noise variance map anisotropies (basically the same as point sources but acting on beam-convolved maps)	\begin{equation}
	W^{r, st}_\ell = \frac 14\delta_{r0}\delta_{s0}\delta_{t0}  \frac{1}{b_\ell^2}
	\end{equation}
\end{enumerate}


Let as before $s, t$ denote collectively the QE spins and weight functions for an estimator $_r\hat \alpha(\hn)$ of spin $r = s_o + t_o$, and let $r'$ be the spin of anisotropy source $_{r'}\beta(\hn)$ with covariance response kernel $W^{r'}$ as above. Let $\mathcal R_L^{g_r g_{r'}} \delta_{LL'}\delta_{MM'}$ be defined as the response of the gradient mode of $\alpha_{LM}$ to the gradient mode of $\beta_{L'M'}$, and similarly for the curl. It holds: \begin{equation}\boxed{
	\begin{split}
		\resp^{g_rg_{r'}}_L &= \Re\left[R_L^{st, r'} + (-1)^{r'} R_L^{st, -r'}\right]\\
		\resp^{c_rc_{r'}}_L &= \Re\left[R_L^{st, r'} - (-1)^{r'} R_L^{st, -r'}\right] \\
		\resp^{g_rc_{r'}}_L &= \Im\left[-R_L^{st, r'} + (-1)^{r'} R_L^{st, -r'} \right]  \\
		\resp^{c_rg_{r'}}_L &= \Im\left[R_L^{st, r'} + (-1)^{r'} R_L^{st, -r'} \right] \\
	\end{split}}
\end{equation}
where
\begin{equation}
\boxed{
\begin{split}
R_L^{st, r'} &= (-1)^{r}2\pi  \int_{-1}^1 d \mu\: d^L_{-r-r'}(\mu)\sum_{\tilde s_i,\tilde t_i = 0,2,-2}  \left[\xi^{\so \si \tilde s_i} (\mu)\psi^{\to \ti \tilde t_i \tilde s_i, r' }(\mu) +  \xi^{\to \ti \tilde t_i}(\mu) \psi^{\so \si \tilde s_i \tilde t_i, r' }(\mu) \right]
\end{split}}
\end{equation}
and
\begin{equation}
\boxed{
\begin{split}
\xi^{\so\si \tilde s_i}(\mu) &\equiv  \sum_\ell \left(\frac{2\ell + 1}{4\pi}\right)w^{\so\si}_\ell F_\ell^{\si \tilde \si} d^\ell_{\so,\tilde \si}(\mu) \\
\psi^{\so\si \tilde \si \tilde \ti, r'}(\mu) &\equiv  (-1)^{r'} \sum_\ell \left(\frac{2\ell + 1}{4\pi}\right)w^{\so \si}F^{\si \tilde \si}_\ell W_\ell^{*-r', -\tilde \ti \tilde \si} d^\ell_{\so,-\tilde \ti + r'}(\mu) 
\end{split}}
\end{equation}
Again, in most relevant cases, the gradient to curl and curl to gradient responses do vanish. If there is a unique source of anisotropy, properly normalized gradient and curl estimators are then given by $\hat g^r_{LM} / \mathcal R_L^{g_rg_r}$ and $\hat c^r_{LM} / \mathcal R_L^{c_r c_r}$.

\subsection{Optimal QE weights}Optimal (in the sense of minimal Gaussian variance) QE weights are easily gained from the representation in Eq.~\ref{eq:covresp} of the anisotropy. Let the CMB likelihood gradients be
\begin{equation}
	_{\pm r}\hat \alpha(\hn) = \left.\frac{\delta }{\delta _{\mp r}\alpha (\hn)} -\frac 12\: _{s_1}X \Cov^{-1}_{s_1s_2} \:_{s_2}X \right|_{\alpha \equiv 0}
\end{equation}
where $\Cov_{s_1 s_2}(\hn, \hn') \equiv \av{_{s_1}X^{}(\hn) \:_{s_2}X^{}(\hn') }$, and where $_r\alpha(\hn)$ and $_{-r}\alpha(\hn)$ are treated as independent variables. 
Using Eq.~\eqref{eq:covresp} and comparing to Eq.~\eqref{QE}, we find
\begin{equation}\boxed{
	w_\ell^{st} = \delta_{st} \textrm{   (1st leg)  } \quad 	w_\ell^{-s + r, t} = 2W^{-r, -st}_\ell \textrm{   (2nd leg)  }}
\end{equation} \JC{why 2 again? }
\JC{FIXME: The right expression is 
\begin{equation}
	_{r}\hat g(\hn) = \sum_{s}\: _{-s}\bar X(\hn)\cdot \left( 2W_{\ell}^{-r, st} \:_{t}\bar X_{\ell m}\: _{s + r}Y_{\ell m}(\hn)\right)
\end{equation}
where $\bar X$ has the $(0, 2, -2)$ elements (note the additional factor of 2! in pol w.r.t. to naive spin defs.)
\begin{equation}
\begin{pmatrix}
	\bar T \\ -\frac 12 \left( \bar E + i \bar B \right) \\-\frac 12 \left( \bar E - i \bar B \right)
\end{pmatrix}	
\end{equation}
Factor of 2 in front of W comes from 2 $ \delta/  \delta\: _{-r}\alpha(\hn)$ to get $d/dre + d/dim$ (?).}
\bibliography{lensing}
\end{document}